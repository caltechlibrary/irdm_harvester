name: Harvest from DOI

on:
  workflow_dispatch:
    inputs:
      doi:
        description: 'DOI or multiple DOIs (separated by a space) to harvest from'
        required: true

jobs:
  prepare-dois:
    name: Prepare Matrix Output of DOIs
    runs-on: ubuntu-latest
    outputs: 
      dois: ${{ steps.step1.outputs.matrix }}
    env:
      DOI: ${{ github.event.inputs.doi }}
    steps: 
      - name: Checkout
        uses: actions/checkout@v3
      - name: Process DOIs
        shell: bash
        run: python split_doi.py >> $GITHUB_OUTPUT
        id: step1
  harvest:
    runs-on: ubuntu-latest
    needs: [prepare-dois]
    strategy:
      fail-fast: false
      matrix:
        doi: ${{ fromJSON(needs.prepare-dois.outputs.dois) }}
    outputs:
      dois: ${{ steps.step1.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Python Deps
        shell: bash
        run: pip install -r requirements.txt
      - name: Make downloads folder
        shell: bash
        run: mkdir $HOME/Downloads
      - name: Install irdmtools
        shell: bash
        run: curl https://caltechlibrary.github.io/irdmtools/installer.sh | sh
      - name: Path
        shell: bash
        run: cp $HOME/bin/doi2rdm $HOME/.local/bin/.
      - name: Harvest DOIs
        shell: bash
        env:
            RDMTOK: ${{ secrets.RDMTOK }}
        id: harvest
        run: python harvest.py doi -doi "${{matrix.doi}}" -actor ${{github.actor}} >> $GITHUB_OUTPUT
      - uses: cloudposse/github-action-matrix-outputs-write@main
        id: out
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ matrix.doi }}
          outputs: |-
            doi: ${{ steps.harvest.outputs.doi }}
            error: ${{steps.harvest.outputs.error }}
  report-status:
    name: Report Status
    runs-on: ubuntu-latest
    needs: [harvest]
    outputs:
      result: "${{ steps.read.outputs.result }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: read
        uses: cloudposse/github-action-matrix-outputs-read@main
        id: read
        with:
          matrix-step-name: harvest
      - name: Commit File
        uses: EndBug/add-and-commit@v9
        with:
          message: 'Update harvested_dois.txt'
          add: "['harvested_dois.txt']"
